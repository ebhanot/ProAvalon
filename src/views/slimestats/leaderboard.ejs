<%- include('../partials/header') %>

<link rel="stylesheet" type="text/css" href="/stylesheets/profile.css">
<link rel="stylesheet" type="text/css" href="/libraries/flag-icon/css/flag-icon.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>

<style>
    .avatarImg {
        width: 128px;
        height: 128px;
    }
</style>

<script>
async function fetchUser(username) {
    const res = await fetch('/ajax/profile/getProfileData/' + username);
    if (!res.ok) return null;
    return await res.json();
}

function pct(wins, losses) {
    const total = wins + losses;
    return total === 0 ? 0 : Math.round((wins / total) * 100);
}


document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("compareBtn").addEventListener("click", async () => {
        const userA = document.getElementById("userAInput").value.trim();
        const userB = document.getElementById("userBInput").value.trim();

        if (!userA || !userB) {
            alert("Please enter both usernames.");
            return;
        }

        const dataA = await fetchUser(userA);
        const dataB = await fetchUser(userB);

        if (!dataA || !dataB) {
            alert("One or both users were not found.");
            return;
        }

        drawHeadToHeadChart(dataA.userData, dataB.userData);
    });
});

let h2hChartInstance = null;

function drawHeadToHeadChart(a, b) {
    const aSpyWins = a.totalWins - a.totalResWins;
    const aSpyLoss = a.totalLosses - a.totalResLosses;

    const bSpyWins = b.totalWins - b.totalResWins;
    const bSpyLoss = b.totalLosses - b.totalResLosses;

    const aData = [pct(a.totalResWins, a.totalResLosses), pct(aSpyWins, aSpyLoss)];
    const bData = [pct(b.totalResWins, b.totalResLosses), pct(bSpyWins, bSpyLoss)];

    if (h2hChartInstance) h2hChartInstance.destroy();

    const ctx = document.getElementById("h2hChart").getContext("2d");

    // Chart.js v2-compatible horizontal bar
    h2hChartInstance = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: ['Resistance Win %', 'Spy Win %'],
            datasets: [
                {
                    label: a.username,
                    backgroundColor: 'rgba(54,162,235,0.5)',
                    borderColor: 'rgba(54,162,235,1)',
                    borderWidth: 1,
                    data: aData
                },
                {
                    label: b.username,
                    backgroundColor: 'rgba(255,99,132,0.5)',
                    borderColor: 'rgba(255,99,132,1)',
                    borderWidth: 1,
                    data: bData
                }
            ]
        },
        options: {
            scales: {
                xAxes: [{
                    ticks: {
                        beginAtZero: true,
                        callback: val => val + "%",
                        suggestedMax: 100
                    }
                }]
            },
            tooltips: {
                callbacks: {
                    label: (item, data) => {
                        const username = data.datasets[item.datasetIndex].label;
                        return `${username}: ${item.value}%`;
                    }
                }
            }
        }
    });
}
</script>

<div class="container myContainer">
  <div class="row" id="h2hContainer" style="margin-top: 40px;">
  <div class="col-xs-12">
    <h2><u>Head-to-Head Winrate Comparison</u></h2>

    <div class="row">
      <div class="col-xs-12 col-md-5">
        <input id="userAInput" class="form-control" placeholder="Enter User A Username">
      </div>

      <div class="col-xs-12 col-md-5">
        <input id="userBInput" class="form-control" placeholder="Enter User B Username">
      </div>

      <div class="col-xs-12 col-md-2">
        <button id="compareBtn" class="btn btn-primary btn-block">Compare</button>
      </div>
    </div>

    <br>
    <div style="width: 100%;">
      <canvas id="h2hChart"></canvas>
    </div>
  </div>
</div>

<br><br><br><br><br><br><br>

<script>
$('#searchInput').on('keydown', function(e) {
    const search = $('#searchInput').val();
    if (e.keyCode === 13 && search.trim()) window.location.href = search;
});

$('#searchButton').on('click', function() {
    const search = $('#searchInput').val();
    if (search.trim()) window.location.href = search;
});
</script>

<%- include('../partials/footer') %>